<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Metrics Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional look and feel */
        :root {
            --color-primary: #3b82f6; /* Blue 500 */
            --color-success: #10b981; /* Emerald 500 */
            --color-warning: #f59e0b; /* Amber 500 */
            --color-danger: #ef4444; /* Red 500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }

        .metric-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            cursor: default;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .input-field {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Responsive Table adjustments */
        @media (max-width: 768px) {
            .historical-table thead {
                display: none;
            }
            .historical-table, .historical-table tbody, .historical-table tr, .historical-table td {
                display: block;
                width: 100%;
            }
            .historical-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
            }
            .historical-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
            }
            .historical-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(50% - 20px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="message-box" class="fixed top-0 inset-x-0 z-50 p-4 transition-all duration-300 transform -translate-y-full"></div>

    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Startup Metrics Dashboard</h1>
        <p class="text-gray-500">Track key financial and customer performance metrics.</p>
    </header>

    <!-- Metrics Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">

        <!-- MRR Card -->
        <div class="metric-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-start">
                <h2 class="text-lg font-semibold text-gray-500">Latest MRR ($)</h2>
                <span id="mrr-growth" class="text-sm font-medium text-green-600 bg-green-100 px-2 py-0.5 rounded-full"></span>
            </div>
            <p id="latest-mrr" class="text-3xl font-bold mt-2 text-gray-800">$0</p>
            <p class="text-sm text-gray-400 mt-1">Monthly Recurring Revenue</p>
        </div>

        <!-- Cash Card -->
        <div class="metric-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-start">
                <h2 class="text-lg font-semibold text-gray-500">Cash Balance</h2>
                <p class="text-sm font-medium text-gray-400">Total Cash:</p>
            </div>
            <p id="total-cash" class="text-3xl font-bold mt-2 text-gray-800">$0</p>
            <p class="text-sm text-gray-400 mt-1">What is our current cash position?</p>
        </div>

        <!-- Burn Rate Card -->
        <div class="metric-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-start">
                <h2 class="text-lg font-semibold text-gray-500">Monthly Burn Rate (Avg)</h2>
                <p class="text-sm font-medium text-gray-400">Avg Monthly Spend</p>
            </div>
            <p id="burn-rate" class="text-3xl font-bold mt-2 text-gray-800">$0.00</p>
            <p class="text-sm text-gray-400 mt-1">Why is cash changing? (Average costs)</p>
        </div>

        <!-- Runway Card -->
        <div class="metric-card bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-start">
                <h2 class="text-lg font-semibold text-gray-500">Runway (Months)</h2>
                <span id="runway-growth" class="text-sm font-medium text-green-600 bg-green-100 px-2 py-0.5 rounded-full">Infinite</span>
            </div>
            <p id="runway" class="text-3xl font-bold mt-2 text-gray-800">0</p>
            <p class="text-sm text-gray-400 mt-1">How long will cash last at current spending?</p>
        </div>

    </div>

    <!-- Data Entry Section -->
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-12 border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Add Monthly Entry</h2>
        <form id="data-entry-form" class="grid grid-cols-2 md:grid-cols-7 gap-4 items-end">
            <input type="month" id="month" placeholder="Month (e.g., May 24)" required class="input-field col-span-2 md:col-span-1">
            <input type="number" id="mrr" placeholder="MRR ($)" required class="input-field">
            <input type="number" id="newCustomers" placeholder="New Cust." required class="input-field">
            <input type="number" id="churn" placeholder="Customer Churn" required class="input-field">
            <input type="number" id="opex" placeholder="Operating Expen. ($)" required class="input-field">
            <input type="number" id="cash" placeholder="Cash Balance ($)" required class="input-field">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg col-span-2 md:col-span-1">Add Data</button>
        </form>
        <p id="form-error" class="text-sm text-red-500 mt-2 hidden"></p>
    </div>

    <!-- Historical Performance Table -->
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-12 border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Historical Performance (Descriptive)</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left historical-table">
                <thead>
                    <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Period</th>
                        <th class="py-3 px-6 text-right">MRR ($)</th>
                        <th class="py-3 px-6 text-right">New Cust.</th>
                        <th class="py-3 px-6 text-right">Churn</th>
                        <th class="py-3 px-6 text-right">Opex ($)</th>
                        <th class="py-3 px-6 text-right">Cash ($)</th>
                        <th class="py-3 px-6 text-right">Action</th>
                    </tr>
                </thead>
                <tbody id="historical-data" class="text-gray-600 text-sm font-light">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Data Management Section -->
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Data Backup & Management</h2>
        <div class="flex flex-wrap gap-4">
            <button id="export-data" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                Export Data (JSON)
            </button>
            <input type="file" id="import-file" accept=".json" class="hidden">
            <button id="import-data" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                Import Data (JSON)
            </button>
            <button id="clear-data" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                Clear All Data
            </button>
        </div>
    </div>


<script>
    // --- Global Variables and Constants ---
    const STORAGE_KEY = 'startupMetricsData';
    let appData = []; // Array to hold all metric entries

    // --- Utility Functions ---

    /**
     * Formats a number as a currency string.
     * @param {number} value The number to format.
     * @returns {string} The formatted currency string.
     */
    function formatCurrency(value) {
        if (typeof value !== 'number' || isNaN(value)) return '$0';
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    /**
     * Shows a temporary, styled message box.
     * @param {string} message The message to display.
     * @param {'success' | 'danger' | 'warning'} type The type of message (determines color).
     */
    function showMessage(message, type) {
        const box = document.getElementById('message-box');
        let bgColor = '';
        let textColor = '';

        if (type === 'success') {
            bgColor = 'bg-green-500';
            textColor = 'text-white';
        } else if (type === 'danger') {
            bgColor = 'bg-red-500';
            textColor = 'text-white';
        } else if (type === 'warning') {
            bgColor = 'bg-yellow-500';
            textColor = 'text-gray-900';
        }

        box.innerHTML = `<div class="max-w-md mx-auto p-4 rounded-lg shadow-xl font-semibold ${bgColor} ${textColor}">${message}</div>`;
        box.classList.remove('-translate-y-full');

        setTimeout(() => {
            box.classList.add('-translate-y-full');
        }, 3000);
    }

    // --- Data Persistence (Load/Save) ---

    /**
     * Generates a simple UUID (v4-like) for new entries.
     * @returns {string} A unique ID string.
     */
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    /**
     * Saves the current appData array to localStorage.
     */
    function saveData() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            console.log(`[STORAGE] Data successfully saved to localStorage. ${appData.length} entries.`);
        } catch (error) {
            console.error('[STORAGE ERROR] Could not save data to localStorage:', error);
            showMessage('Critical Error: Failed to save data. Please check console.', 'danger');
        }
    }

    /**
     * Defines the sample data used when no local data is found.
     * The `id` field is crucial for data manipulation.
     */
    function getSampleData() {
        // Data is intentionally sorted descending by month for easy initial display
        return [
            { id: generateUUID(), month: '2024-12', mrr: 25000, newCustomers: 80, churn: 20, opex: 14000, cash: 430500 },
            { id: generateUUID(), month: '2024-11', mrr: 20000, newCustomers: 75, churn: 18, opex: 13500, cash: 444500 },
            { id: generateUUID(), month: '2024-10', mrr: 15500, newCustomers: 60, churn: 15, opex: 12000, cash: 458500 },
            { id: generateUUID(), month: '2024-09', mrr: 12000, newCustomers: 90, churn: 10, opex: 10500, cash: 470500 },
            { id: generateUUID(), month: '2024-08', mrr: 7500, newCustomers: 70, churn: 8, opex: 10000, cash: 480500 },
            { id: generateUUID(), month: '2024-07', mrr: 3000, newCustomers: 35, churn: 4, opex: 9500, cash: 490500 },
            { id: generateUUID(), month: '2024-06', mrr: 1500, newCustomers: 20, churn: 2, opex: 8000, cash: 500000 }
        ];
    }

    /**
     * Loads data from localStorage or initializes with sample data.
     */
    function loadData() {
        console.log("--- VERSION CHECK V2.0.1: New Logging & Persistence Loaded ---"); // <-- THIS IS THE VERSION CHECK LINE

        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            try {
                const parsedData = JSON.parse(storedData);
                // Filter out any undefined or null entries that might cause the crash
                appData = parsedData.filter(entry => entry && entry.month && entry.id); 
                console.log(`[STORAGE] Loaded ${appData.length} entries from localStorage.`);
                if (appData.length === 0) {
                    // If parsing worked but resulted in 0 entries (e.g. all corrupt data was filtered)
                    appData = getSampleData();
                    saveData(); // Save the new sample data immediately
                    showMessage('Corrupted data removed. Loaded fresh sample data.', 'warning');
                }
            } catch (error) {
                // Critical failure, data is corrupted (not valid JSON)
                console.error('[STORAGE ERROR] Corrupt data found. Using sample data.', error);
                appData = getSampleData();
                saveData(); // Overwrite corrupted data with clean sample data
                showMessage('Critical Data Error: Corrupted data cleaned. Loaded sample data.', 'danger');
            }
        } else {
            // No stored data found, use sample data
            console.log('[STORAGE] No data found. Loading sample data.');
            appData = getSampleData();
            saveData(); // Save sample data for the first time
        }

        // Sort data descending by month for metrics calculation and display
        appData.sort((a, b) => b.month.localeCompare(a.month));
        renderDashboard();
    }


    // --- Core Logic: Calculations and Rendering ---

    /**
     * Calculates and renders all dashboard metrics.
     */
    function renderDashboard() {
        // Sort data descending by month (latest first)
        appData.sort((a, b) => b.month.localeCompare(a.month));

        if (appData.length === 0) {
            document.getElementById('latest-mrr').textContent = '$0';
            document.getElementById('total-cash').textContent = '$0';
            document.getElementById('burn-rate').textContent = '$0.00';
            document.getElementById('runway').textContent = '0';
            document.getElementById('mrr-growth').textContent = '0%';
            document.getElementById('runway-growth').textContent = 'Infinite';
            renderHistoricalTable(); // Still need to clear the table
            return;
        }

        const latest = appData[0];
        const previous = appData[1] || null;

        // 1. MRR
        document.getElementById('latest-mrr').textContent = formatCurrency(latest.mrr);
        const mrrGrowth = previous ? (latest.mrr - previous.mrr) / previous.mrr * 100 : 0;
        const mrrGrowthEl = document.getElementById('mrr-growth');
        mrrGrowthEl.textContent = `${mrrGrowth.toFixed(1)}%`;
        mrrGrowthEl.className = `text-sm font-medium px-2 py-0.5 rounded-full ${mrrGrowth >= 0 ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'}`;

        // 2. Cash Balance
        document.getElementById('total-cash').textContent = formatCurrency(latest.cash);

        // 3. Monthly Burn Rate (Average of Opex over all months)
        const totalOpex = appData.reduce((sum, entry) => sum + entry.opex, 0);
        const avgBurnRate = totalOpex / appData.length;
        document.getElementById('burn-rate').textContent = formatCurrency(avgBurnRate);

        // 4. Runway
        // Use the average cash change over the last two months for a more immediate trend.
        const latestCashChange = previous ? latest.cash - previous.cash : 0;
        const avgCashChange = appData.length >= 2
            ? (latest.cash - appData[appData.length - 1].cash) / (appData.length - 1)
            : latestCashChange;
        
        // Use the immediate cash change (Latest Cash - Latest Opex) as the primary burn/gain rate
        const effectiveBurnRate = latest.opex - (latest.mrr - previous.mrr); // Simplified: Opex minus MRR change
        const monthlyChange = latest.cash - (previous ? previous.cash : latest.cash); // Actual monthly change

        let effectiveMonthlyCashChange = monthlyChange; // Use the actual cash change

        let runwayMonths = 0;
        let runwayText = 'Infinite';

        if (effectiveMonthlyCashChange < 0) {
            // Cash is decreasing (Burn)
            runwayMonths = Math.abs(latest.cash / effectiveMonthlyCashChange);
            runwayText = runwayMonths.toFixed(1);
        } else if (effectiveMonthlyCashChange >= 0) {
            // Cash is flat or increasing (Gain)
            runwayText = 'Infinite';
        }

        document.getElementById('runway').textContent = runwayText;
        document.getElementById('runway-growth').textContent = effectiveMonthlyCashChange >= 0 ? 'Cash Positive' : 'Burning Cash';
        
        const runwayGrowthEl = document.getElementById('runway-growth');
        runwayGrowthEl.className = `text-sm font-medium px-2 py-0.5 rounded-full ${effectiveMonthlyCashChange >= 0 ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'}`;


        renderHistoricalTable();
    }


    /**
     * Renders the historical data table.
     */
    function renderHistoricalTable() {
        const tableBody = document.getElementById('historical-data');
        tableBody.innerHTML = ''; // Clear existing rows

        appData.forEach((entry, index) => {
            const row = tableBody.insertRow();
            row.className = 'border-b border-gray-200 hover:bg-gray-100';

            const monthLabel = entry.month; // e.g., "2024-12"

            // Data structure: [Label, Value, Alignment, RawValue]
            const cells = [
                ['Period', monthLabel, 'left'],
                ['MRR ($)', formatCurrency(entry.mrr), 'right'],
                ['New Cust.', entry.newCustomers, 'right'],
                ['Churn', entry.churn, 'right'],
                ['Opex ($)', formatCurrency(entry.opex), 'right'],
                ['Cash ($)', formatCurrency(entry.cash), 'right'],
            ];

            cells.forEach(([label, value, align]) => {
                const cell = row.insertCell();
                cell.className = `py-3 px-6 text-${align}`;
                cell.setAttribute('data-label', label); // For mobile view
                cell.textContent = value;
            });

            // Action Cell (Delete button)
            const actionCell = row.insertCell();
            actionCell.className = 'py-3 px-6 text-right';
            actionCell.setAttribute('data-label', 'Action');
            actionCell.innerHTML = `<button class="text-red-500 hover:text-red-700 transition duration-150 delete-btn" data-id="${entry.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>`;
        });

        // Attach event listeners for delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', handleDeleteEntry);
        });
    }


    // --- Event Handlers ---

    /**
     * Handles adding or updating a metric entry.
     */
    function handleFormSubmit(event) {
        event.preventDefault();

        const formErrorEl = document.getElementById('form-error');
        formErrorEl.classList.add('hidden');
        formErrorEl.textContent = '';

        const monthInput = document.getElementById('month').value;
        const newEntry = {
            id: generateUUID(),
            month: monthInput,
            mrr: parseInt(document.getElementById('mrr').value),
            newCustomers: parseInt(document.getElementById('newCustomers').value),
            churn: parseInt(document.getElementById('churn').value),
            opex: parseInt(document.getElementById('opex').value),
            cash: parseInt(document.getElementById('cash').value)
        };

        // Check for existing entry (prevents duplicate months)
        const existingIndex = appData.findIndex(entry => entry.month === newEntry.month);

        if (existingIndex !== -1) {
            // Case 1: Entry exists (update it)
            const confirmation = window.confirm(`An entry for ${newEntry.month} already exists. Do you want to overwrite it?`);
            if (confirmation) {
                newEntry.id = appData[existingIndex].id; // Preserve original ID
                appData[existingIndex] = newEntry;
                showMessage(`Entry for ${newEntry.month} successfully updated.`, 'success');
            } else {
                return; // Stop the process
            }
        } else {
            // Case 2: New entry (add it)
            appData.push(newEntry);
            showMessage(`New entry for ${newEntry.month} added successfully.`, 'success');
        }

        saveData();
        renderDashboard();
        event.target.reset(); // Clear the form
    }

    /**
     * Handles the deletion of a metric entry.
     */
    function handleDeleteEntry(event) {
        const idToDelete = event.currentTarget.getAttribute('data-id');

        const confirmation = window.confirm('Are you sure you want to delete this historical entry?');
        if (!confirmation) {
            return;
        }

        const initialLength = appData.length;
        appData = appData.filter(entry => entry.id !== idToDelete);

        if (appData.length < initialLength) {
            saveData();
            renderDashboard();
            showMessage('Entry successfully deleted.', 'warning');
        } else {
            showMessage('Error: Could not find entry to delete.', 'danger');
        }
    }


    // --- Data Management Handlers ---

    /**
     * Handles the export of data to a JSON file.
     */
    function handleExportData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'startup_metrics_backup.json';

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();

        showMessage('Data exported successfully!', 'success');
    }

    /**
     * Handles clearing all data and reloading sample data.
     */
    function handleClearData() {
        const confirmation = window.confirm('WARNING: This will permanently delete ALL historical data and load sample data. Are you absolutely sure?');
        if (confirmation) {
            localStorage.removeItem(STORAGE_KEY);
            appData = getSampleData(); // Load sample data directly
            saveData(); // Save the clean sample data
            renderDashboard();
            showMessage('All data cleared. Sample data reloaded.', 'danger');
        }
    }

    /**
     * Handles importing data from a JSON file.
     */
    function handleImportData() {
        document.getElementById('import-file').click();
    }

    /**
     * Processes the imported JSON file.
     */
    function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                // Basic validation: must be an array, and entries must have month/id
                if (Array.isArray(importedData) && importedData.every(item => item && item.month && item.id)) {
                    appData = importedData;
                    saveData();
                    renderDashboard();
                    showMessage(`Successfully imported ${appData.length} entries.`, 'success');
                } else {
                    showMessage('Import failed. File content is not a valid data format.', 'danger');
                }
            } catch (error) {
                console.error('Import error:', error);
                showMessage('Import failed. Invalid JSON file format.', 'danger');
            }
        };
        reader.readAsText(file);
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        // Attach main event listener
        document.getElementById('data-entry-form').addEventListener('submit', handleFormSubmit);

        // Attach data management listeners
        document.getElementById('export-data').addEventListener('click', handleExportData);
        document.getElementById('import-data').addEventListener('click', handleImportData);
        document.getElementById('clear-data').addEventListener('click', handleClearData);
        document.getElementById('import-file').addEventListener('change', handleImportFile);

        // Initial data load and rendering
        loadData();
    });

</script>
</body>
</html>
